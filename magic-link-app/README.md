# マジックリンク認証アプリケーション

このアプリケーションは、マジックリンク認証（パスワードレス認証）を実装したNext.jsウェブアプリケーションです。
ユーザーはメールアドレスを入力するだけで、ログイン用のリンクがメールで送信され、そのリンクをクリックするだけでログインできます。

## アプリの起動方法

### 1. Dockerによるコンテナの起動

このアプリケーションはDockerを使用してPostgreSQLデータベースを起動します。以下のコマンドでコンテナを起動してください：

```bash
docker-compose up -d
```

これにより、PostgreSQLデータベースが起動し、`5432`ポートでアクセス可能になります。

### 2. Prismaの設定

データベース接続のために、`.env`ファイルを作成し、以下の内容を追加してください：

```
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/magic_link_db?schema=public"
```

その後、Prismaのデータベーススキーマを反映します：

```bash
npx prisma db push
```

### 3. Gmailのアプリパスワードの取得と設定

マジックリンクメールを送信するために、Gmailのアプリパスワードを取得し、`.env`ファイルに追加する必要があります：

1. Googleアカウントの2段階認証を有効にします
2. [Googleアカウントのセキュリティ設定](https://myaccount.google.com/security)にアクセスします
3. 「アプリパスワード」を選択し、新しいアプリパスワードを生成します
4. 生成されたパスワードを`.env`ファイルに以下のように追加します：

```
SMTP_USER="your.email@gmail.com"
SMTP_PASSWORD="your-app-password"
EMAIL_FROM="your.email@gmail.com"
NEXT_PUBLIC_BASE_URL="http://localhost:3000"
```

### 4. アプリケーションの起動

依存関係をインストールし、開発サーバーを起動します：

```bash
npm install
npm run dev
```

これで、アプリケーションが`http://localhost:3000`で利用可能になります。

## アプリの概要

### マジックリンク認証の仕組み

このアプリケーションは以下の流れでユーザー認証を行います：

1. ユーザーがメールアドレスを入力
2. システムが一時的なトークンを生成し、データベースに保存
3. ログイン用のマジックリンク（トークン付き）がユーザーのメールアドレスに送信される
4. ユーザーがメール内のリンクをクリック
5. システムがトークンを検証し、有効であれば新しいセッションを作成してユーザーをログイン状態にする

### セキュリティ上の注意点

このアプリケーションは学習・実験目的で作成されており、**セキュリティ上の問題点**があります：

- **セッション管理の問題**: ログアウト時にセッションをデータベースから完全に削除していません。`auth.ts`の`deleteSession`関数では、セッションストアからの削除とクッキーの削除を行っていますが、データベースからのセッション削除が実装されていません。
- **トークンの自動削除の未実装**: 期限切れのトークンを自動的に削除する機能がコメントアウトされています。

実際のプロダクション環境では、これらの問題点を修正し、適切なセキュリティ対策を施すことが必要です。

## 技術スタック

- **フロントエンド**: Next.js, React, Tailwind CSS
- **バックエンド**: Next.js API Routes, Server Actions
- **データベース**: PostgreSQL
- **ORM**: Prisma
- **メール送信**: Nodemailer
- **コンテナ化**: Docker, Docker Compose

## ライセンス

このプロジェクトは学習目的で作成されており、自由にご利用いただけます。
